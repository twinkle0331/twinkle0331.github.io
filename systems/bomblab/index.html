<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.3.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Serif+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/font-awesome@4/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","images":"/images","scheme":"Mist","version":"8.2.2","exturl":false,"sidebar":{"position":"right","display":"remove","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}};
  </script>
<meta name="description" content="真相只有一个！从扑朔迷离的线索里推理出真相总是那么刺激。我们将在bomblab体会如何根据星星点点的线索，胡乱假设合理推断，大胆验证，从而揭开真相神秘的面纱。bomblab的场景为拆炸弹，任何一个输入不正确均会引发炸弹爆炸。根据二进制文件反汇编形成的汇编代码来推断应该输入的字符串，解锁6个关卡和待解锁的神秘关卡。">
<meta property="og:type" content="article">
<meta property="og:title" content="bomblab">
<meta property="og:url" content="http://example.com/systems/bomblab/index.html">
<meta property="og:site_name" content="trinkle">
<meta property="og:description" content="真相只有一个！从扑朔迷离的线索里推理出真相总是那么刺激。我们将在bomblab体会如何根据星星点点的线索，胡乱假设合理推断，大胆验证，从而揭开真相神秘的面纱。bomblab的场景为拆炸弹，任何一个输入不正确均会引发炸弹爆炸。根据二进制文件反汇编形成的汇编代码来推断应该输入的字符串，解锁6个关卡和待解锁的神秘关卡。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-04-08T00:05:28.000Z">
<meta property="article:modified_time" content="2021-03-27T13:17:35.000Z">
<meta property="article:author" content="trinkle">
<meta property="article:tag" content="csapp">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/systems/bomblab/">


<script class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>
<title>bomblab | trinkle</title>
  




  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="trinkle" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">trinkle</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top" role="button">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/systems/bomblab/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="trinkle">
      <meta itemprop="description" content="Stay foolish,stay hungry.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="trinkle">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          bomblab
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-04-08 08:05:28" itemprop="dateCreated datePublished" datetime="2019-04-08T08:05:28+08:00">2019-04-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Systems/" itemprop="url" rel="index"><span itemprop="name">Systems</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <p>真相只有一个！从扑朔迷离的线索里推理出真相总是那么刺激。我们将在bomblab体会如何根据星星点点的线索，<del>胡乱假设</del>合理推断，大胆验证，从而揭开真相神秘的面纱。bomblab的场景为拆炸弹，任何一个输入不正确均会引发炸弹爆炸。根据二进制文件反汇编形成的汇编代码来推断应该输入的字符串，解锁6个关卡和待解锁的神秘关卡。</p>
<a id="more"></a>

<p><code>bomblab</code>链接地址：<a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/3e/bomb.tar">bomblab</a><br><code>gdb</code>指南：<a target="_blank" rel="noopener" href="http://csapp.cs.cmu.edu/3e/docs/gdbnotes-x86-64.pdf">gdbnotes</a></p>
<p>首先反汇编得到bomb二进制文件对应的汇编代码<br><code>objdump -d bomb &gt; bomb.txt</code><br>将反汇编得到的汇编代码重定向到<code>bomb.txt</code>中</p>
<h1 id="phase-1"><a href="#phase-1" class="headerlink" title="phase_1"></a>phase_1</h1><p><code>phase_1</code>对应的汇编代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000000000400</span>ee0 &lt;phase_1&gt;:</span><br><span class="line">  <span class="number">400</span>ee0:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">08</span>          	sub    $<span class="number">0x8</span>,%rsp</span><br><span class="line">  <span class="number">400</span>ee4:	be <span class="number">00</span> <span class="number">24</span> <span class="number">40</span> <span class="number">00</span>       	mov    $<span class="number">0x402400</span>,%esi</span><br><span class="line">  <span class="number">400</span>ee9:	e8 <span class="number">4</span>a <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">401338</span> &lt;strings_not_equal&gt;</span><br><span class="line">  <span class="number">400</span>eee:	<span class="number">85</span> c0                	test   %eax,%eax</span><br><span class="line">  <span class="number">400</span>ef0:	<span class="number">74</span> <span class="number">05</span>                	je     <span class="number">400</span>ef7 &lt;phase_1+<span class="number">0x17</span>&gt;</span><br><span class="line">  <span class="number">400</span>ef2:	e8 <span class="number">43</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">40143</span>a &lt;explode_bomb&gt;</span><br><span class="line">  <span class="number">400</span>ef7:	<span class="number">48</span> <span class="number">83</span> c4 <span class="number">08</span>          	add    $<span class="number">0x8</span>,%rsp</span><br><span class="line">  <span class="number">400</span>efb:	c3                   	retq   </span><br></pre></td></tr></table></figure>
<p>在地址0x400ee9处调用了string_not_equal函数，在调用之前将立即数0x402400存入了%esi中，%rsi为第二个参数所用寄存器，我们推测%rdi存储我们输入的字符串。<br>使用<code>gdb bomb</code>开始调试程序，在phase_1函数处设置断点验证。<br>观察到%rdi为地址的字符串正是我们输入的字符串。由函数名称<code>strings_not_equal</code> 推测该函数用于判断输入的字符串是否和0x402400处的字符串相等，使用<code>x/s 0x402400</code>显示0x402400处对应的字符串内容<br>“Border relations with Canada have never been better.”</p>
<h1 id="phase-2"><a href="#phase-2" class="headerlink" title="phase_2"></a>phase_2</h1><p><code>phase_2</code>函数对应汇编代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000000000400</span>efc &lt;phase_2&gt;:</span><br><span class="line">  <span class="number">400</span>efc:	<span class="number">55</span>                   	push   %rbp</span><br><span class="line">  <span class="number">400</span>efd:	<span class="number">53</span>                   	push   %rbx<span class="comment">//被调用者保存</span></span><br><span class="line">  <span class="number">400</span>efe:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">28</span>          	sub    $<span class="number">0x28</span>,%rsp<span class="comment">//分配栈空间</span></span><br><span class="line">  <span class="number">400f</span>02:	<span class="number">48</span> <span class="number">89</span> e6             	mov    %rsp,%rsi<span class="comment">//保存栈顶指针</span></span><br><span class="line">  <span class="number">400f</span>05:	e8 <span class="number">52</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">40145</span>c &lt;read_six_numbers&gt;   </span><br></pre></td></tr></table></figure>
<p>查看phase_2的汇编代码，第6行调用了<code>read_six_numbers</code> 来读入输入数据，根据函数名可知该函数应该是用于读入六个数字，接下来转到<code>read_six_numbers</code> 的汇编代码部分，推断读入的六个数存储在rsp开始的24个字节中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">000000000040145</span>c &lt;read_six_numbers&gt;:</span><br><span class="line">  <span class="number">40145</span>c:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">18</span>          	sub    $<span class="number">0x18</span>,%rsp<span class="comment">//分配栈空间</span></span><br><span class="line">  <span class="number">401460</span>:	<span class="number">48</span> <span class="number">89</span> f2             	mov    %rsi,%rdx</span><br><span class="line">  <span class="number">401463</span>:	<span class="number">48</span> <span class="number">8</span>d <span class="number">4</span>e <span class="number">04</span>          	lea    <span class="number">0x4</span>(%rsi),%rcx</span><br><span class="line">  <span class="number">401467</span>:	<span class="number">48</span> <span class="number">8</span>d <span class="number">46</span> <span class="number">14</span>          	lea    <span class="number">0x14</span>(%rsi),%rax</span><br><span class="line">  <span class="number">40146b</span>:	<span class="number">48</span> <span class="number">89</span> <span class="number">44</span> <span class="number">24</span> <span class="number">08</span>       	mov    %rax,<span class="number">0x8</span>(%rsp)</span><br><span class="line">  <span class="number">401470</span>:	<span class="number">48</span> <span class="number">8</span>d <span class="number">46</span> <span class="number">10</span>          	lea    <span class="number">0x10</span>(%rsi),%rax</span><br><span class="line">  <span class="number">401474</span>:	<span class="number">48</span> <span class="number">89</span> <span class="number">04</span> <span class="number">24</span>          	mov    %rax,(%rsp)</span><br><span class="line">  <span class="number">401478</span>:	<span class="number">4</span>c <span class="number">8</span>d <span class="number">4</span>e <span class="number">0</span>c          	lea    <span class="number">0xc</span>(%rsi),%r9</span><br><span class="line">  <span class="number">40147</span>c:	<span class="number">4</span>c <span class="number">8</span>d <span class="number">46</span> <span class="number">08</span>          	lea    <span class="number">0x8</span>(%rsi),%r8</span><br><span class="line">  <span class="number">401480</span>:	be c3 <span class="number">25</span> <span class="number">40</span> <span class="number">00</span>       	mov    $<span class="number">0x4025c3</span>,%esi</span><br><span class="line">  <span class="number">401485</span>:	b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x0</span>,%eax</span><br><span class="line">  <span class="number">40148</span>a:	e8 <span class="number">61</span> f7 ff ff       	callq  <span class="number">400b</span>f0 &lt;__isoc99_sscanf@plt&gt;</span><br><span class="line">  <span class="number">40148f</span>:	<span class="number">83</span> f8 <span class="number">05</span>             	cmp    $<span class="number">0x5</span>,%eax</span><br><span class="line">  <span class="number">401492</span>:	<span class="number">7f</span> <span class="number">05</span>                	jg     <span class="number">401499</span> &lt;read_six_numbers+<span class="number">0x3d</span>&gt;</span><br><span class="line">  <span class="number">401494</span>:	e8 a1 ff ff ff       	callq  <span class="number">40143</span>a &lt;explode_bomb&gt;</span><br><span class="line">  <span class="number">401499</span>:	<span class="number">48</span> <span class="number">83</span> c4 <span class="number">18</span>          	add    $<span class="number">0x18</span>,%rsp</span><br><span class="line">  <span class="number">40149</span>d:	c3                   	retq </span><br></pre></td></tr></table></figure>
<p>在<code>read_six_numbers</code>返回后设置断点<code>break *0x400f0a</code>，输入<code>1 2 3 4 5 6</code>，执行后<code>x /32xb $rsp</code>查看rsp后32个字节的内容，如下所示，int大小为4个字节，以小端法存储</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7fffffffe3c0</span>: <span class="number">0x01</span>    <span class="number">0x00</span>    <span class="number">0x00</span>    <span class="number">0x00</span>    <span class="number">0x02</span>    <span class="number">0x00</span>    <span class="number">0x00</span>    <span class="number">0x00</span></span><br><span class="line"><span class="number">0x7fffffffe3c8</span>: <span class="number">0x03</span>    <span class="number">0x00</span>    <span class="number">0x00</span>    <span class="number">0x00</span>    <span class="number">0x04</span>    <span class="number">0x00</span>    <span class="number">0x00</span>    <span class="number">0x00</span></span><br><span class="line"><span class="number">0x7fffffffe3d0</span>: <span class="number">0x05</span>    <span class="number">0x00</span>    <span class="number">0x00</span>    <span class="number">0x00</span>    <span class="number">0x06</span>    <span class="number">0x00</span>    <span class="number">0x00</span>    <span class="number">0x00</span></span><br><span class="line"><span class="number">0x7fffffffe3d8</span>: <span class="number">0x31</span>    <span class="number">0x14</span>    <span class="number">0x40</span>    <span class="number">0x00</span>    <span class="number">0x00</span>    <span class="number">0x00</span>    <span class="number">0x00</span>    <span class="number">0x00</span></span><br></pre></td></tr></table></figure>
<p>接下来查看调用输入结束后的汇编代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">400f</span>0a:	<span class="number">83</span> <span class="number">3</span>c <span class="number">24</span> <span class="number">01</span>          	cmpl   $<span class="number">0x1</span>,(%rsp)<span class="comment">//将栈顶元素与1比较</span></span><br><span class="line"><span class="number">400f</span>0e:	<span class="number">74</span> <span class="number">20</span>                	je     <span class="number">400f</span>30 &lt;phase_2+<span class="number">0x34</span>&gt;</span><br><span class="line"><span class="number">400f</span>10:	e8 <span class="number">25</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">40143</span>a &lt;explode_bomb&gt;</span><br><span class="line"><span class="number">400f</span>15:	eb <span class="number">19</span>                	jmp    <span class="number">400f</span>30 &lt;phase_2+<span class="number">0x34</span>&gt;<span class="comment">//在explode_bomb调用返回后才会执行</span></span><br><span class="line"><span class="number">400f</span>17:	<span class="number">8b</span> <span class="number">43</span> fc             	mov    <span class="number">-0x4</span>(%rbx),%eax</span><br><span class="line"><span class="number">400f</span>1a:	<span class="number">01</span> c0                	add    %eax,%eax</span><br><span class="line"><span class="number">400f</span>1c:	<span class="number">39</span> <span class="number">03</span>                	cmp    %eax,(%rbx)</span><br><span class="line"><span class="number">400f</span>1e:	<span class="number">74</span> <span class="number">05</span>                	je     <span class="number">400f</span>25 &lt;phase_2+<span class="number">0x29</span>&gt;</span><br><span class="line"><span class="number">400f</span>20:	e8 <span class="number">15</span> <span class="number">05</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">40143</span>a &lt;explode_bomb&gt;</span><br><span class="line"><span class="number">400f</span>25:	<span class="number">48</span> <span class="number">83</span> c3 <span class="number">04</span>          	add    $<span class="number">0x4</span>,%rbx</span><br><span class="line"><span class="number">400f</span>29:	<span class="number">48</span> <span class="number">39</span> eb             	cmp    %rbp,%rbx</span><br><span class="line"><span class="number">400f</span>2c:	<span class="number">75</span> e9                	jne    <span class="number">400f</span>17 &lt;phase_2+<span class="number">0x1b</span>&gt;</span><br><span class="line"><span class="number">400f</span>2e:	eb <span class="number">0</span>c                	jmp    <span class="number">400f</span>3c &lt;phase_2+<span class="number">0x40</span>&gt;</span><br><span class="line"><span class="number">400f</span>30:	<span class="number">48</span> <span class="number">8</span>d <span class="number">5</span>c <span class="number">24</span> <span class="number">04</span>       	lea    <span class="number">0x4</span>(%rsp),%rbx</span><br><span class="line"><span class="number">400f</span>35:	<span class="number">48</span> <span class="number">8</span>d <span class="number">6</span>c <span class="number">24</span> <span class="number">18</span>       	lea    <span class="number">0x18</span>(%rsp),%rbp</span><br><span class="line"><span class="number">400f</span>3a:	eb db                	jmp    <span class="number">400f</span>17 &lt;phase_2+<span class="number">0x1b</span>&gt;</span><br><span class="line"><span class="number">400f</span>3c:	<span class="number">48</span> <span class="number">83</span> c4 <span class="number">28</span>          	add    $<span class="number">0x28</span>,%rsp</span><br><span class="line"><span class="number">400f</span>40:	<span class="number">5b</span>                   	pop    %rbx</span><br><span class="line"><span class="number">400f</span>41:	<span class="number">5</span>d                   	pop    %rbp</span><br><span class="line"><span class="number">400f</span>42:	c3                   	retq</span><br></pre></td></tr></table></figure>
<p>phase_2段的代码首先将rsp对应地址中存放的值与1比较，如果相等则跳过引爆炸弹的代码，那么首元素必定为1。<br>然后跳转至<code>400f30</code>处，将<code>rsp+0x4</code>与<code>rsp+0x18</code>的值分别存放到了rbx与rbp，此后跳转至<code>400f17</code>，将rbx的地址减4中存放的内容复制到了eax中，rbx的地址减4也就意味着与rsp相等，它的值也就是第一个读入的值。下一行将eax的值乘二，接下来将乘二后的值与rbx也就是第二个值进行比较，如果相同则跳过引爆代码。此后将rbx加4，指向下一个数存放的位置，一直循环直到rbx的值大于边界rbp的值为止。<br>可知，后一个数为前一个数的2倍时炸弹不引爆，输入的六个数分别为1，2，4，8，16，32</p>
<h1 id="phase-3"><a href="#phase-3" class="headerlink" title="phase_3"></a>phase_3</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000000000400f</span>43 &lt;phase_3&gt;:</span><br><span class="line">  <span class="number">400f</span>43:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">18</span>          	sub    $<span class="number">0x18</span>,%rsp</span><br><span class="line">  <span class="number">400f</span>47:	<span class="number">48</span> <span class="number">8</span>d <span class="number">4</span>c <span class="number">24</span> <span class="number">0</span>c       	lea    <span class="number">0xc</span>(%rsp),%rcx</span><br><span class="line">  <span class="number">400f</span>4c:	<span class="number">48</span> <span class="number">8</span>d <span class="number">54</span> <span class="number">24</span> <span class="number">08</span>       	lea    <span class="number">0x8</span>(%rsp),%rdx</span><br><span class="line">  <span class="number">400f</span>51:	be cf <span class="number">25</span> <span class="number">40</span> <span class="number">00</span>       	mov    $<span class="number">0x4025cf</span>,%esi</span><br><span class="line">  <span class="number">400f</span>56:	b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x0</span>,%eax</span><br><span class="line">  <span class="number">400f</span>5b:	e8 <span class="number">90</span> fc ff ff       	callq  <span class="number">400b</span>f0 &lt;__isoc99_sscanf@plt&gt;  </span><br></pre></td></tr></table></figure>
<p>在调用<mark class="label default">400bf0 __isoc99_sscanf</mark>之前将%esi赋值为立即数0x4025cf，<mark class="label default">x /s 0x4025cf</mark>查看0x4025cf处的值，为<mark class="label default">"%d %d"</mark>,读入两个整形值。这两个值存放在哪里呢？之前将rsp+0xc与rsp+0x8的值分别给rcx与rdx，推测输入的两个数同样存放在栈中。<br>为了验证这一推测，<mark class="label default">break *0x400f60</mark>设置断点，<mark class="label default">x/8xd $rsp</mark>查看rsp开始6字节的内容，如下所示</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x7ffffffee0a8</span>: <span class="number">1</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">2</span>       <span class="number">0</span>       <span class="number">0</span>       <span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>接下来查看调用输入结束后的汇编代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">400f</span>60:   <span class="number">83</span> f8 <span class="number">01</span>                cmp    $<span class="number">0x1</span>,%eax</span><br><span class="line"><span class="number">400f</span>63:   <span class="number">7f</span> <span class="number">05</span>                   jg     <span class="number">400f</span>6a &lt;phase_3+<span class="number">0x27</span>&gt;</span><br><span class="line"><span class="number">400f</span>65:   e8 d0 <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">40143</span>a &lt;explode_bomb&gt;</span><br><span class="line"><span class="number">400f</span>6a:   <span class="number">83</span> <span class="number">7</span>c <span class="number">24</span> <span class="number">08</span> <span class="number">07</span>          cmpl   $<span class="number">0x7</span>,<span class="number">0x8</span>(%rsp)</span><br><span class="line"><span class="number">400f</span>6f:   <span class="number">77</span> <span class="number">3</span>c                   ja     <span class="number">400f</span>ad &lt;phase_3+<span class="number">0x6a</span>&gt;</span><br><span class="line"><span class="number">400f</span>71:   <span class="number">8b</span> <span class="number">44</span> <span class="number">24</span> <span class="number">08</span>             mov    <span class="number">0x8</span>(%rsp),%eax</span><br><span class="line"><span class="number">400f</span>75:   ff <span class="number">24</span> c5 <span class="number">70</span> <span class="number">24</span> <span class="number">40</span> <span class="number">00</span>    jmpq   *<span class="number">0x402470</span>(,%rax,<span class="number">8</span>)<span class="comment">//0x402470处存放跳转表</span></span><br><span class="line"><span class="number">400f</span>7c:   b8 cf <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0xcf</span>,%eax  <span class="comment">//当第一个数为0时跳转到此处</span></span><br><span class="line"><span class="number">400f</span>81:   eb <span class="number">3b</span>                   jmp    <span class="number">400f</span>be &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line"><span class="number">400f</span>83:   b8 c3 <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x2c3</span>,%eax <span class="comment">//当第一个数为2时跳转到此处</span></span><br><span class="line"><span class="number">400f</span>88:   eb <span class="number">34</span>                   jmp    <span class="number">400f</span>be &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line"><span class="number">400f</span>8a:   b8 <span class="number">00</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x100</span>,%eax <span class="comment">//第一个数为3时跳转到此处</span></span><br><span class="line"><span class="number">400f</span>8f:   eb <span class="number">2</span>d                   jmp    <span class="number">400f</span>be &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line"><span class="number">400f</span>91:   b8 <span class="number">85</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x185</span>,%eax <span class="comment">//第一个数为4时跳转到此处</span></span><br><span class="line"><span class="number">400f</span>96:   eb <span class="number">26</span>                   jmp    <span class="number">400f</span>be &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line"><span class="number">400f</span>98:   b8 ce <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0xce</span>,%eax <span class="comment">//第一个数为5时跳转到此处</span></span><br><span class="line"><span class="number">400f</span>9d:   eb <span class="number">1f</span>                   jmp    <span class="number">400f</span>be &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line"><span class="number">400f</span>9f:   b8 aa <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x2aa</span>,%eax <span class="comment">//第一个数为6时跳转到此处</span></span><br><span class="line"><span class="number">400f</span>a4:   eb <span class="number">18</span>                   jmp    <span class="number">400f</span>be &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line"><span class="number">400f</span>a6:   b8 <span class="number">47</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x147</span>,%eax</span><br><span class="line"><span class="number">400f</span>ab:   eb <span class="number">11</span>                   jmp    <span class="number">400f</span>be &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line"><span class="number">400f</span>ad:   e8 <span class="number">88</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">40143</span>a &lt;explode_bomb&gt;</span><br><span class="line"><span class="number">400f</span>b2:   b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x0</span>,%eax</span><br><span class="line"><span class="number">400f</span>b7:   eb <span class="number">05</span>                   jmp    <span class="number">400f</span>be &lt;phase_3+<span class="number">0x7b</span>&gt;</span><br><span class="line"><span class="number">400f</span>b9:   b8 <span class="number">37</span> <span class="number">01</span> <span class="number">00</span> <span class="number">00</span>          mov    $<span class="number">0x137</span>,%eax <span class="comment">//当第一个数为1时跳转到此处</span></span><br><span class="line"><span class="number">400f</span>be:   <span class="number">3b</span> <span class="number">44</span> <span class="number">24</span> <span class="number">0</span>c             cmp    <span class="number">0xc</span>(%rsp),%eax</span><br><span class="line"><span class="number">400f</span>c2:   <span class="number">74</span> <span class="number">05</span>                   je     <span class="number">400f</span>c9 &lt;phase_3+<span class="number">0x86</span>&gt;</span><br><span class="line"><span class="number">400f</span>c4:   e8 <span class="number">71</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>          callq  <span class="number">40143</span>a &lt;explode_bomb&gt;</span><br><span class="line"><span class="number">400f</span>c9:   <span class="number">48</span> <span class="number">83</span> c4 <span class="number">18</span>             add    $<span class="number">0x18</span>,%rsp</span><br><span class="line"><span class="number">400f</span>cd:   c3                      retq </span><br></pre></td></tr></table></figure>
<p>rsp+0x8中存放的值复制入eax，然后进行一个跳转，跳转到的地址为<code>0x402470(,%rax,8)</code>，这就是一个典型的switch语句的实现，根据跳转表跳转至相应位置，将对应的立即数赋值给eax，然后再将eax的值与第二个数比较，若不等则引爆炸弹。<br>全部解如下所示：</p>
<table>
<thead>
<tr>
<th align="center">第一个数</th>
<th align="center">第二个数</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0</td>
<td align="center">0xcf=207</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">0x137=311</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">0x2c3=707</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">0x100=256</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">0x185=389</td>
</tr>
<tr>
<td align="center">5</td>
<td align="center">0xce=206</td>
</tr>
<tr>
<td align="center">6</td>
<td align="center">0x2aa=682</td>
</tr>
</tbody></table>
<h1 id="phase-4"><a href="#phase-4" class="headerlink" title="phase_4"></a>phase_4</h1><p>phase_4汇编代码如下所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">000000000040100</span>c &lt;phase_4&gt;:</span><br><span class="line">  <span class="number">40100</span>c:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">18</span>          	sub    $<span class="number">0x18</span>,%rsp</span><br><span class="line">  <span class="number">401010</span>:	<span class="number">48</span> <span class="number">8</span>d <span class="number">4</span>c <span class="number">24</span> <span class="number">0</span>c       	lea    <span class="number">0xc</span>(%rsp),%rcx</span><br><span class="line">  <span class="number">401015</span>:	<span class="number">48</span> <span class="number">8</span>d <span class="number">54</span> <span class="number">24</span> <span class="number">08</span>       	lea    <span class="number">0x8</span>(%rsp),%rdx</span><br><span class="line">  <span class="number">40101</span>a:	be cf <span class="number">25</span> <span class="number">40</span> <span class="number">00</span>       	mov    $<span class="number">0x4025cf</span>,%esi</span><br><span class="line">  <span class="number">40101f</span>:	b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x0</span>,%eax</span><br><span class="line">  <span class="number">401024</span>:	e8 c7 fb ff ff       	callq  <span class="number">400b</span>f0 &lt;__isoc99_sscanf@plt&gt;</span><br><span class="line">  <span class="number">401029</span>:	<span class="number">83</span> f8 <span class="number">02</span>             	cmp    $<span class="number">0x2</span>,%eax</span><br><span class="line">  <span class="number">40102</span>c:	<span class="number">75</span> <span class="number">07</span>                	jne    <span class="number">401035</span> &lt;phase_4+<span class="number">0x29</span>&gt;</span><br><span class="line">  <span class="number">40102</span>e:	<span class="number">83</span> <span class="number">7</span>c <span class="number">24</span> <span class="number">08</span> <span class="number">0</span>e       	cmpl   $<span class="number">0xe</span>,<span class="number">0x8</span>(%rsp)</span><br><span class="line">  <span class="number">401033</span>:	<span class="number">76</span> <span class="number">05</span>                	jbe    <span class="number">40103</span>a &lt;phase_4+<span class="number">0x2e</span>&gt;</span><br><span class="line">  <span class="number">401035</span>:	e8 <span class="number">00</span> <span class="number">04</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">40143</span>a &lt;explode_bomb&gt;</span><br><span class="line">  <span class="number">40103</span>a:	ba <span class="number">0</span>e <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0xe</span>,%edx</span><br><span class="line">  <span class="number">40103f</span>:	be <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x0</span>,%esi</span><br><span class="line">  <span class="number">401044</span>:	<span class="number">8b</span> <span class="number">7</span>c <span class="number">24</span> <span class="number">08</span>          	mov    <span class="number">0x8</span>(%rsp),%edi</span><br><span class="line">  <span class="number">401048</span>:	e8 <span class="number">81</span> ff ff ff       	callq  <span class="number">400f</span>ce &lt;func4&gt;</span><br><span class="line">  <span class="number">40104</span>d:	<span class="number">85</span> c0                	test   %eax,%eax</span><br><span class="line">  <span class="number">40104f</span>:	<span class="number">75</span> <span class="number">07</span>                	jne    <span class="number">401058</span> &lt;phase_4+<span class="number">0x4c</span>&gt;</span><br><span class="line">  <span class="number">401051</span>:	<span class="number">83</span> <span class="number">7</span>c <span class="number">24</span> <span class="number">0</span>c <span class="number">00</span>       	cmpl   $<span class="number">0x0</span>,<span class="number">0xc</span>(%rsp)</span><br><span class="line">  <span class="number">401056</span>:	<span class="number">74</span> <span class="number">05</span>                	je     <span class="number">40105</span>d &lt;phase_4+<span class="number">0x51</span>&gt;</span><br><span class="line">  <span class="number">401058</span>:	e8 dd <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">40143</span>a &lt;explode_bomb&gt;</span><br><span class="line">  <span class="number">40105</span>d:	<span class="number">48</span> <span class="number">83</span> c4 <span class="number">18</span>          	add    $<span class="number">0x18</span>,%rsp</span><br><span class="line">  <span class="number">401061</span>:	c3                   	retq   </span><br></pre></td></tr></table></figure>
<p>在调用<code>func4</code>后将返回值是否为0，验证第二个数是否为0，由此可知第二个数一定为0，在执行func4后确保返回值一定为0，接下来分析<code>func4</code>部分的汇编代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000000000400f</span>ce &lt;func4&gt;:</span><br><span class="line">  <span class="number">400f</span>ce:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">08</span>          	sub    $<span class="number">0x8</span>,%rsp</span><br><span class="line">  <span class="number">400f</span>d2:	<span class="number">89</span> d0                	mov    %edx,%eax</span><br><span class="line">  <span class="number">400f</span>d4:	<span class="number">29</span> f0                	sub    %esi,%eax</span><br><span class="line">  <span class="number">400f</span>d6:	<span class="number">89</span> c1                	mov    %eax,%ecx</span><br><span class="line">  <span class="number">400f</span>d8:	c1 e9 <span class="number">1f</span>             	shr    $<span class="number">0x1f</span>,%ecx</span><br><span class="line">  <span class="number">400f</span>db:	<span class="number">01</span> c8                	add    %ecx,%eax</span><br><span class="line">  <span class="number">400f</span>dd:	d1 f8                	sar    %eax</span><br><span class="line">  <span class="number">400f</span>df:	<span class="number">8</span>d <span class="number">0</span>c <span class="number">30</span>             	lea    (%rax,%rsi,<span class="number">1</span>),%ecx</span><br><span class="line">  <span class="number">400f</span>e2:	<span class="number">39</span> f9                	cmp    %edi,%ecx</span><br><span class="line">  <span class="number">400f</span>e4:	<span class="number">7</span>e <span class="number">0</span>c                	jle    <span class="number">400f</span>f2 &lt;func4+<span class="number">0x24</span>&gt;</span><br><span class="line">  <span class="number">400f</span>e6:	<span class="number">8</span>d <span class="number">51</span> ff             	lea    <span class="number">-0x1</span>(%rcx),%edx</span><br><span class="line">  <span class="number">400f</span>e9:	e8 e0 ff ff ff       	callq  <span class="number">400f</span>ce &lt;func4&gt;</span><br><span class="line">  <span class="number">400f</span>ee:	<span class="number">01</span> c0                	add    %eax,%eax</span><br><span class="line">  <span class="number">400f</span>f0:	eb <span class="number">15</span>                	jmp    <span class="number">401007</span> &lt;func4+<span class="number">0x39</span>&gt;</span><br><span class="line">  <span class="number">400f</span>f2:	b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x0</span>,%eax</span><br><span class="line">  <span class="number">400f</span>f7:	<span class="number">39</span> f9                	cmp    %edi,%ecx</span><br><span class="line">  <span class="number">400f</span>f9:	<span class="number">7</span>d <span class="number">0</span>c                	jge    <span class="number">401007</span> &lt;func4+<span class="number">0x39</span>&gt;</span><br><span class="line">  <span class="number">400f</span>fb:	<span class="number">8</span>d <span class="number">71</span> <span class="number">01</span>             	lea    <span class="number">0x1</span>(%rcx),%esi</span><br><span class="line">  <span class="number">400f</span>fe:	e8 cb ff ff ff       	callq  <span class="number">400f</span>ce &lt;func4&gt;</span><br><span class="line">  <span class="number">401003</span>:	<span class="number">8</span>d <span class="number">44</span> <span class="number">00</span> <span class="number">01</span>          	lea    <span class="number">0x1</span>(%rax,%rax,<span class="number">1</span>),%eax</span><br><span class="line">  <span class="number">401007</span>:	<span class="number">48</span> <span class="number">83</span> c4 <span class="number">08</span>          	add    $<span class="number">0x8</span>,%rsp</span><br><span class="line">  <span class="number">40100b</span>:	c3                   	retq  </span><br></pre></td></tr></table></figure>
<p>将其转换为c语言代码如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">func4</span><span class="params">(<span class="keyword">int</span> x,<span class="keyword">int</span> y,<span class="keyword">int</span> z)</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">//x in %rdi,y in %rsi,z in %rdx,t in %rax,k in %ecx</span></span><br><span class="line"> <span class="comment">//y的初始值为0，z的初始值为14</span></span><br><span class="line">  <span class="keyword">int</span> t=z-y;</span><br><span class="line">  <span class="keyword">int</span> k=t&gt;&gt;<span class="number">31</span>;</span><br><span class="line">  t=(t+k)&gt;&gt;<span class="number">1</span>;</span><br><span class="line">  k=t+y;</span><br><span class="line">  <span class="keyword">if</span>(k==x) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span>(k&gt;x)</span><br><span class="line">  &#123;</span><br><span class="line">    z=k<span class="number">-1</span>;</span><br><span class="line">    func4(x,y,z);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>*t;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(k&lt;x)</span><br><span class="line">  &#123;</span><br><span class="line">	y=k+<span class="number">1</span>;</span><br><span class="line">	func4(x,y,z);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">2</span>*t+<span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要求最后得到的t为0，则x可以取为0，1，3，7</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt;= <span class="number">0xe</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(func4(i,<span class="number">0</span>,<span class="number">0xe</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d\n&quot;</span>,i);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="phase-5"><a href="#phase-5" class="headerlink" title="phase_5"></a>phase_5</h1><p>phase_5的汇编代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000000000401062</span> &lt;phase_5&gt;:</span><br><span class="line">  <span class="number">401062</span>:	<span class="number">53</span>                   	push   %rbx</span><br><span class="line">  <span class="number">401063</span>:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">20</span>          	sub    $<span class="number">0x20</span>,%rsp</span><br><span class="line">  <span class="number">401067</span>:	<span class="number">48</span> <span class="number">89</span> fb             	mov    %rdi,%rbx</span><br><span class="line">  <span class="number">40106</span>a:	<span class="number">64</span> <span class="number">48</span> <span class="number">8b</span> <span class="number">04</span> <span class="number">25</span> <span class="number">28</span> <span class="number">00</span> 	mov    %fs:<span class="number">0x28</span>,%rax</span><br><span class="line">  <span class="number">401071</span>:	<span class="number">00</span> <span class="number">00</span> </span><br><span class="line">  <span class="number">401073</span>:	<span class="number">48</span> <span class="number">89</span> <span class="number">44</span> <span class="number">24</span> <span class="number">18</span>       	mov    %rax,<span class="number">0x18</span>(%rsp)</span><br></pre></td></tr></table></figure>
<p>把输入的地址rdi赋值给rbx,之后的操作防止栈溢出，设置金丝雀值。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">401078</span>:	<span class="number">31</span> c0                	<span class="keyword">xor</span>    %eax,%eax</span><br><span class="line"><span class="number">40107</span>a:	e8 <span class="number">9</span>c <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">40131b</span> &lt;string_length&gt;</span><br><span class="line"><span class="number">40107f</span>:	<span class="number">83</span> f8 <span class="number">06</span>             	cmp    $<span class="number">0x6</span>,%eax</span><br><span class="line"><span class="number">401082</span>:	<span class="number">74</span> <span class="number">4</span>e                	je     <span class="number">4010</span>d2 &lt;phase_5+<span class="number">0x70</span>&gt;</span><br><span class="line"><span class="number">401084</span>:	e8 b1 <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">40143</span>a &lt;explode_bomb&gt;</span><br></pre></td></tr></table></figure>
<p>第一行清空了eax，之后调用了<code>string_length</code>，返回值是字符串的长度，若不等于6则引爆炸弹。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4010</span>d2:	b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x0</span>,%eax</span><br><span class="line"><span class="number">4010</span>d7:	eb b2                	jmp    <span class="number">40108b</span> &lt;phase_5+<span class="number">0x29</span>&gt;</span><br></pre></td></tr></table></figure>
<p>将eax置为0后跳转至<code>40108b</code>处</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">40108b</span>:	<span class="number">0f</span> b6 <span class="number">0</span>c <span class="number">03</span>          	movzbl (%rbx,%rax,<span class="number">1</span>),%ecx</span><br><span class="line"><span class="number">40108f</span>:	<span class="number">88</span> <span class="number">0</span>c <span class="number">24</span>             	mov    %cl,(%rsp)</span><br><span class="line"><span class="number">401092</span>:	<span class="number">48</span> <span class="number">8b</span> <span class="number">14</span> <span class="number">24</span>          	mov    (%rsp),%rdx</span><br><span class="line"><span class="number">401096</span>:	<span class="number">83</span> e2 <span class="number">0f</span>             	<span class="keyword">and</span>    $<span class="number">0xf</span>,%edx</span><br><span class="line"><span class="number">401099</span>:	<span class="number">0f</span> b6 <span class="number">92</span> b0 <span class="number">24</span> <span class="number">40</span> <span class="number">00</span> 	movzbl <span class="number">0x4024b0</span>(%rdx),%edx</span><br><span class="line"><span class="number">4010</span>a0:	<span class="number">88</span> <span class="number">54</span> <span class="number">04</span> <span class="number">10</span>          	mov    %dl,<span class="number">0x10</span>(%rsp,%rax,<span class="number">1</span>)</span><br><span class="line"><span class="number">4010</span>a4:	<span class="number">48</span> <span class="number">83</span> c0 <span class="number">01</span>          	add    $<span class="number">0x1</span>,%rax</span><br><span class="line"><span class="number">4010</span>a8:	<span class="number">48</span> <span class="number">83</span> f8 <span class="number">06</span>          	cmp    $<span class="number">0x6</span>,%rax</span><br><span class="line"><span class="number">4010</span>ac:	<span class="number">75</span> dd                	jne    <span class="number">40108b</span> &lt;phase_5+<span class="number">0x29</span>&gt;</span><br></pre></td></tr></table></figure>
<p>movzbl命令将从rbx（输入）开始的rax位置的一个字节赋给ecx的低16位。接下来的两行先把cl中的值（ecx的低八位）复制到rsp处，再将rsp中的值复制到rdx中，再使用掩码0xf取edx的低4位。上述操作即为：取读入的字符串中rax位置处的字符，再取它的低4位放在edx中。<br>将地址0x4024b0+rdx中的一个字节放入edx的低16位中，并将这16位复制到了rsp+0x10+rax的位置中。<br>循环一共进行了6次，分别读取了输入的6个字符，记录这个6个字符的低6位作为索引rdx，从0x4024b0+rdx的位置复制一个字节到rsp+0x10开始的6字节中。结束之后，rsp+0x10之后的位置存放了6个字符。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">4010ae:	c6 44 24 16 00       	movb   $0x0,0x16(%rsp)</span><br></pre></td></tr></table></figure>
<p>在rsp+0x16的位置也就是6个字符之后置上一个0x0也就是终止符\0。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4010b</span>3:	be <span class="number">5</span>e <span class="number">24</span> <span class="number">40</span> <span class="number">00</span>       	mov    $<span class="number">0x40245e</span>,%esi</span><br><span class="line"><span class="number">4010b</span>8:	<span class="number">48</span> <span class="number">8</span>d <span class="number">7</span>c <span class="number">24</span> <span class="number">10</span>       	lea    <span class="number">0x10</span>(%rsp),%rdi</span><br><span class="line"><span class="number">4010b</span>d:	e8 <span class="number">76</span> <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">401338</span> &lt;strings_not_equal&gt;</span><br><span class="line"><span class="number">4010</span>c2:	<span class="number">85</span> c0                	test   %eax,%eax</span><br><span class="line"><span class="number">4010</span>c4:	<span class="number">74</span> <span class="number">13</span>                	je     <span class="number">4010</span>d9 &lt;phase_5+<span class="number">0x77</span>&gt;</span><br><span class="line"><span class="number">4010</span>c6:	e8 <span class="number">6f</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">40143</span>a &lt;explode_bomb&gt;</span><br></pre></td></tr></table></figure>
<p>将<code>0x40245e</code>这个地址赋给esi，把rsp+0x10这个地址赋给rdi，接下来调用strings_not_equal这个函数，esi与rdi即为要比较的两个字符串的首地址，如果两个字符串不相同就引爆炸弹。<br><code>x/s 0x40245e</code>查看<code>0x402465e</code>处的字符串，这就是我们应该从之前的字符串中取出并且放在rsp+0x10处的字符串</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x40245e</span>:       <span class="string">&quot;flyers&quot;</span></span><br></pre></td></tr></table></figure>
<p><code>x/s 0x4024b0</code>查看之前的字符串</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x4024b0</span> &lt;<span class="built_in">array</span><span class="number">.3449</span>&gt;:  <span class="string">&quot;maduiersnfotvbylSo you think you can stop the bomb with ctrl-c, do you?&quot;</span></span><br></pre></td></tr></table></figure>
<p>需要的字符flyers的索引分别为9 15 14 5 6 7。这个索引就是我们输入的字符的低4位，那我们只要找到低4位分别是以上数值的字符就可以了。查阿斯克码表得到一个答案为<mark class="label default">ionefg</mark></p>
<h1 id="phase-6"><a href="#phase-6" class="headerlink" title="phase_6"></a>phase_6</h1><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000004010f</span>4 &lt;phase_6&gt;:</span><br><span class="line">  <span class="number">4010f</span>4:	<span class="number">41</span> <span class="number">56</span>                	push   %r14</span><br><span class="line">  <span class="number">4010f</span>6:	<span class="number">41</span> <span class="number">55</span>                	push   %r13</span><br><span class="line">  <span class="number">4010f</span>8:	<span class="number">41</span> <span class="number">54</span>                	push   %r12</span><br><span class="line">  <span class="number">4010f</span>a:	<span class="number">55</span>                   	push   %rbp</span><br><span class="line">  <span class="number">4010f</span>b:	<span class="number">53</span>                   	push   %rbx</span><br><span class="line">  <span class="number">4010f</span>c:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">50</span>          	sub    $<span class="number">0x50</span>,%rsp</span><br><span class="line">  <span class="number">401100</span>:	<span class="number">49</span> <span class="number">89</span> e5             	mov    %rsp,%r13</span><br><span class="line">  <span class="number">401103</span>:	<span class="number">48</span> <span class="number">89</span> e6             	mov    %rsp,%rsi</span><br><span class="line">  <span class="number">401106</span>:	e8 <span class="number">51</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">40145</span>c &lt;read_six_numbers&gt;</span><br></pre></td></tr></table></figure>
<p>与之前类似，同样读入6个数字，存入栈中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">40110b</span>:	<span class="number">49</span> <span class="number">89</span> e6             	mov    %rsp,%r14</span><br><span class="line"> <span class="number">40110</span>e:	<span class="number">41</span> bc <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>    	mov    $<span class="number">0x0</span>,%r12d</span><br><span class="line"> <span class="number">401114</span>:	<span class="number">4</span>c <span class="number">89</span> ed             	mov    %r13,%rbp</span><br><span class="line"> <span class="number">401117</span>:	<span class="number">41</span> <span class="number">8b</span> <span class="number">45</span> <span class="number">00</span>          	mov    <span class="number">0x0</span>(%r13),%eax</span><br><span class="line"> <span class="number">40111b</span>:	<span class="number">83</span> e8 <span class="number">01</span>             	sub    $<span class="number">0x1</span>,%eax</span><br><span class="line"> <span class="number">40111</span>e:	<span class="number">83</span> f8 <span class="number">05</span>             	cmp    $<span class="number">0x5</span>,%eax</span><br><span class="line"> <span class="number">401121</span>:	<span class="number">76</span> <span class="number">05</span>                	jbe    <span class="number">401128</span> &lt;phase_6+<span class="number">0x34</span>&gt;</span><br><span class="line"> <span class="number">401123</span>:	e8 <span class="number">12</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">40143</span>a &lt;explode_bomb&gt;</span><br><span class="line"> <span class="number">401128</span>:	<span class="number">41</span> <span class="number">83</span> c4 <span class="number">01</span>          	add    $<span class="number">0x1</span>,%r12d</span><br><span class="line"> <span class="number">40112</span>c:	<span class="number">41</span> <span class="number">83</span> fc <span class="number">06</span>          	cmp    $<span class="number">0x6</span>,%r12d</span><br><span class="line"> <span class="number">401130</span>:	<span class="number">74</span> <span class="number">21</span>                	je     <span class="number">401153</span> &lt;phase_6+<span class="number">0x5f</span>&gt;</span><br><span class="line"> <span class="number">401132</span>:	<span class="number">44</span> <span class="number">89</span> e3             	mov    %r12d,%ebx</span><br><span class="line"> <span class="number">401135</span>:	<span class="number">48</span> <span class="number">63</span> c3             	movslq %ebx,%rax</span><br><span class="line"> <span class="number">401138</span>:	<span class="number">8b</span> <span class="number">04</span> <span class="number">84</span>             	mov    (%rsp,%rax,<span class="number">4</span>),%eax</span><br><span class="line"> <span class="number">40113b</span>:	<span class="number">39</span> <span class="number">45</span> <span class="number">00</span>             	cmp    %eax,<span class="number">0x0</span>(%rbp)</span><br><span class="line"> <span class="number">40113</span>e:	<span class="number">75</span> <span class="number">05</span>                	jne    <span class="number">401145</span> &lt;phase_6+<span class="number">0x51</span>&gt;</span><br><span class="line"> <span class="number">401140</span>:	e8 f5 <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">40143</span>a &lt;explode_bomb&gt;</span><br><span class="line"> <span class="number">401145</span>:	<span class="number">83</span> c3 <span class="number">01</span>             	add    $<span class="number">0x1</span>,%ebx</span><br><span class="line"> <span class="number">401148</span>:	<span class="number">83</span> fb <span class="number">05</span>             	cmp    $<span class="number">0x5</span>,%ebx</span><br><span class="line"> <span class="number">40114b</span>:	<span class="number">7</span>e e8                	jle    <span class="number">401135</span> &lt;phase_6+<span class="number">0x41</span>&gt;</span><br><span class="line"> <span class="number">40114</span>d:	<span class="number">49</span> <span class="number">83</span> c5 <span class="number">04</span>          	add    $<span class="number">0x4</span>,%r13</span><br><span class="line"> <span class="number">401151</span>:	eb c1                	jmp    <span class="number">401114</span> &lt;phase_6+<span class="number">0x20</span>&gt;</span><br></pre></td></tr></table></figure>
<p>开始是一系列赋值操作，eax中的值是rsp位置存放的值。第6、7两行将eax中的值减一后与5进行比较，小于等于5则跳过引爆代码。也就是说rsp中存放的第一个数必须小于等于6。<br>接下来执行两层循环，外循环由r12d控制循环次数，%r13指定元素位置，内循环由ebx指定索引，所有值之间进行两两比较，并将所有值与6比较。由此可知，读入的6个数必须小于等于6且互不相等。<br>上述循环结束后r12d等于6，跳转至以下位置。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">401153</span>:	<span class="number">48</span> <span class="number">8</span>d <span class="number">74</span> <span class="number">24</span> <span class="number">18</span>       	lea    <span class="number">0x18</span>(%rsp),%rsi</span><br><span class="line"><span class="number">401158</span>:	<span class="number">4</span>c <span class="number">89</span> f0             	mov    %r14,%rax</span><br><span class="line"><span class="number">40115b</span>:	b9 <span class="number">07</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x7</span>,%ecx</span><br><span class="line"><span class="number">401160</span>:	<span class="number">89</span> ca                	mov    %ecx,%edx</span><br><span class="line"><span class="number">401162</span>:	<span class="number">2b</span> <span class="number">10</span>                	sub    (%rax),%edx</span><br><span class="line"><span class="number">401164</span>:	<span class="number">89</span> <span class="number">10</span>                	mov    %edx,(%rax)</span><br><span class="line"><span class="number">401166</span>:	<span class="number">48</span> <span class="number">83</span> c0 <span class="number">04</span>          	add    $<span class="number">0x4</span>,%rax</span><br><span class="line"><span class="number">40116</span>a:	<span class="number">48</span> <span class="number">39</span> f0             	cmp    %rsi,%rax</span><br><span class="line"><span class="number">40116</span>d:	<span class="number">75</span> f1                	jne    <span class="number">401160</span> &lt;phase_6+<span class="number">0x6c</span>&gt;</span><br></pre></td></tr></table></figure>
<p>将r14的值赋给rax，r14的值是之前保存的rsp。这段代码将栈中的6个值（假设为x）变为7-x再存储回栈中。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">40116f</span>:	be <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x0</span>,%esi</span><br><span class="line"><span class="number">401174</span>:	eb <span class="number">21</span>                	jmp    <span class="number">401197</span> &lt;phase_6+<span class="number">0xa3</span>&gt;</span><br><span class="line"><span class="number">401176</span>:	<span class="number">48</span> <span class="number">8b</span> <span class="number">52</span> <span class="number">08</span>          	mov    <span class="number">0x8</span>(%rdx),%rdx</span><br><span class="line"><span class="number">40117</span>a:	<span class="number">83</span> c0 <span class="number">01</span>             	add    $<span class="number">0x1</span>,%eax</span><br><span class="line"><span class="number">40117</span>d:	<span class="number">39</span> c8                	cmp    %ecx,%eax</span><br><span class="line"><span class="number">40117f</span>:	<span class="number">75</span> f5                	jne    <span class="number">401176</span> &lt;phase_6+<span class="number">0x82</span>&gt;</span><br><span class="line"><span class="number">401181</span>:	eb <span class="number">05</span>                	jmp    <span class="number">401188</span> &lt;phase_6+<span class="number">0x94</span>&gt;</span><br><span class="line"><span class="number">401183</span>:	ba d0 <span class="number">32</span> <span class="number">60</span> <span class="number">00</span>       	mov    $<span class="number">0x6032d0</span>,%edx</span><br><span class="line"></span><br><span class="line"><span class="number">401188</span>:	<span class="number">48</span> <span class="number">89</span> <span class="number">54</span> <span class="number">74</span> <span class="number">20</span>       	mov    %rdx,<span class="number">0x20</span>(%rsp,%rsi,<span class="number">2</span>)</span><br><span class="line"><span class="number">40118</span>d:	<span class="number">48</span> <span class="number">83</span> c6 <span class="number">04</span>          	add    $<span class="number">0x4</span>,%rsi</span><br><span class="line"><span class="number">401191</span>:	<span class="number">48</span> <span class="number">83</span> fe <span class="number">18</span>          	cmp    $<span class="number">0x18</span>,%rsi</span><br><span class="line"><span class="number">401195</span>:	<span class="number">74</span> <span class="number">14</span>                	je     <span class="number">4011</span>ab &lt;phase_6+<span class="number">0xb7</span>&gt;</span><br><span class="line"><span class="number">401197</span>:	<span class="number">8b</span> <span class="number">0</span>c <span class="number">34</span>             	mov    (%rsp,%rsi,<span class="number">1</span>),%ecx</span><br><span class="line"><span class="number">40119</span>a:	<span class="number">83</span> f9 <span class="number">01</span>             	cmp    $<span class="number">0x1</span>,%ecx</span><br><span class="line"><span class="number">40119</span>d:	<span class="number">7</span>e e4                	jle    <span class="number">401183</span> &lt;phase_6+<span class="number">0x8f</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="number">40119f</span>:	b8 <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x1</span>,%eax</span><br><span class="line"><span class="number">4011</span>a4:	ba d0 <span class="number">32</span> <span class="number">60</span> <span class="number">00</span>       	mov    $<span class="number">0x6032d0</span>,%edx</span><br><span class="line"><span class="number">4011</span>a9:	eb cb                	jmp    <span class="number">401176</span> &lt;phase_6+<span class="number">0x82</span>&gt;</span><br></pre></td></tr></table></figure>
<p>将rsp+rsi处的数赋给ecx，接下来根据ecx与1的相对大小进行跳转</p>
<ul>
<li> 若小于等于1，将立即数0x6032d0赋值给ecx,接下来将edx的值赋给了rsp+2*rsi+0x20的地址指向的值。rsi为地址偏移量索引，下面一行将rsi增加4，说明从rsp+0x20开始存放8个字节的数据。再将rsi的值与0x18作比较，说明整个过程要进行6次。接下来又到了第14行将下一个int值给rcx。</li>
<li> 若大于1，将0x1赋给eax，19行将0x6032d0这个地址赋给edx，接下来跳转到了第3行，把edx+0x8地址指向的值赋给了edx，<mark class="label default">x/12xg 0x6032d0</mark>查看rbx处的值，如下所示： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x6032d0</span> &lt;node1&gt;:       <span class="number">0x000000010000014c</span>      <span class="number">0x00000000006032e0</span></span><br><span class="line"><span class="number">0x6032e0</span> &lt;node2&gt;:       <span class="number">0x00000002000000a8</span>      <span class="number">0x00000000006032f0</span></span><br><span class="line"><span class="number">0x6032f0</span> &lt;node3&gt;:       <span class="number">0x000000030000039c</span>      <span class="number">0x0000000000603300</span></span><br><span class="line"><span class="number">0x603300</span> &lt;node4&gt;:       <span class="number">0x00000004000002b3</span>      <span class="number">0x0000000000603310</span></span><br><span class="line"><span class="number">0x603310</span> &lt;node5&gt;:       <span class="number">0x00000005000001dd</span>      <span class="number">0x0000000000603320</span></span><br><span class="line"><span class="number">0x603320</span> &lt;node6&gt;:       <span class="number">0x00000006000001bb</span>      <span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
观察可以发现此为一链表结构，每一个node中偏移8个字节中储存的都是下一个节点的地址，那么前面8个字节自然就是节点储存的数据。可知，把edx+0x8地址指向的值赋给了edx，和链表中<mark class="label p=p->next"></mark>操作一致。<br>之后依次从栈中读取存放的6个数放入rcx，再根据rcx的值找到链表中对应的节点，把节点的地址放入rsp+0x20开始的对应位置中。<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4011</span>ab:	<span class="number">48</span> <span class="number">8b</span> <span class="number">5</span>c <span class="number">24</span> <span class="number">20</span>       	mov    <span class="number">0x20</span>(%rsp),%rbx</span><br><span class="line">  <span class="number">4011b</span>0:	<span class="number">48</span> <span class="number">8</span>d <span class="number">44</span> <span class="number">24</span> <span class="number">28</span>       	lea    <span class="number">0x28</span>(%rsp),%rax</span><br><span class="line">  <span class="number">4011b</span>5:	<span class="number">48</span> <span class="number">8</span>d <span class="number">74</span> <span class="number">24</span> <span class="number">50</span>       	lea    <span class="number">0x50</span>(%rsp),%rsi</span><br><span class="line">  <span class="number">4011b</span>a:	<span class="number">48</span> <span class="number">89</span> d9             	mov    %rbx,%rcx</span><br><span class="line">  <span class="number">4011b</span>d:	<span class="number">48</span> <span class="number">8b</span> <span class="number">10</span>             	mov    (%rax),%rdx</span><br><span class="line">  <span class="number">4011</span>c0:	<span class="number">48</span> <span class="number">89</span> <span class="number">51</span> <span class="number">08</span>          	mov    %rdx,<span class="number">0x8</span>(%rcx)</span><br><span class="line">  <span class="number">4011</span>c4:	<span class="number">48</span> <span class="number">83</span> c0 <span class="number">08</span>          	add    $<span class="number">0x8</span>,%rax</span><br><span class="line">  <span class="number">4011</span>c8:	<span class="number">48</span> <span class="number">39</span> f0             	cmp    %rsi,%rax</span><br><span class="line">  <span class="number">4011</span>cb:	<span class="number">74</span> <span class="number">05</span>                	je     <span class="number">4011</span>d2 &lt;phase_6+<span class="number">0xde</span>&gt;</span><br><span class="line">  <span class="number">4011</span>cd:	<span class="number">48</span> <span class="number">89</span> d1             	mov    %rdx,%rcx</span><br><span class="line">  <span class="number">4011</span>d0:	eb eb                	jmp    <span class="number">4011b</span>d &lt;phase_6+<span class="number">0xc9</span>&gt;</span><br><span class="line">  <span class="number">4011</span>d2:	<span class="number">48</span> c7 <span class="number">42</span> <span class="number">08</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> 	movq   $<span class="number">0x0</span>,<span class="number">0x8</span>(%rdx)</span><br></pre></td></tr></table></figure>
这段代码前三行分别将rsp+0x20地址指向值、rsp+0x28的值、rsp+0x50的值赋给了rbx 、rax、rsi。第4行将rbx复制到rcx中，第5行将rax（rsp+0x20）中存放的地址复制入rdx，第6行将这个数据赋给了rcx（也就是rbx、*(rsp+0x20)）节点的指针域。下一步将rax增加8，指向栈中的下一个位置。再与rsi这个临界地址进行比较，如果rax超出末端则跳出这段代码到第12行的位置。</li>
</ul>
<p>下面把rdx中存放的地址值赋给rcx，跳转到第5行重复过程。</p>
<p>仔细分析，这个过程其实就是按照链表节点在栈中的位置重新将链表连接起来，最后跳出的第12行则是把新的表尾的指针域赋为NULL。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">4011</span>d9:	<span class="number">00</span> </span><br><span class="line"><span class="number">4011</span>da:	bd <span class="number">05</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x5</span>,%ebp</span><br><span class="line"><span class="number">4011</span>df:	<span class="number">48</span> <span class="number">8b</span> <span class="number">43</span> <span class="number">08</span>          	mov    <span class="number">0x8</span>(%rbx),%rax</span><br><span class="line"><span class="number">4011e3</span>:	<span class="number">8b</span> <span class="number">00</span>                	mov    (%rax),%eax</span><br><span class="line"><span class="number">4011e5</span>:	<span class="number">39</span> <span class="number">03</span>                	cmp    %eax,(%rbx)</span><br><span class="line"><span class="number">4011e7</span>:	<span class="number">7</span>d <span class="number">05</span>                	jge    <span class="number">4011</span>ee &lt;phase_6+<span class="number">0xfa</span>&gt;</span><br><span class="line"><span class="number">4011e9</span>:	e8 <span class="number">4</span>c <span class="number">02</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">40143</span>a &lt;explode_bomb&gt;</span><br><span class="line"><span class="number">4011</span>ee:	<span class="number">48</span> <span class="number">8b</span> <span class="number">5b</span> <span class="number">08</span>          	mov    <span class="number">0x8</span>(%rbx),%rbx</span><br><span class="line"><span class="number">4011f</span>2:	<span class="number">83</span> ed <span class="number">01</span>             	sub    $<span class="number">0x1</span>,%ebp</span><br><span class="line"><span class="number">4011f</span>5:	<span class="number">75</span> e8                	jne    <span class="number">4011</span>df &lt;phase_6+<span class="number">0xeb</span>&gt;</span><br><span class="line"><span class="number">4011f</span>7:	<span class="number">48</span> <span class="number">83</span> c4 <span class="number">50</span>          	add    $<span class="number">0x50</span>,%rsp</span><br><span class="line"><span class="number">4011f</span>b:	<span class="number">5b</span>                   	pop    %rbx</span><br><span class="line"><span class="number">4011f</span>c:	<span class="number">5</span>d                   	pop    %rbp</span><br><span class="line"><span class="number">4011f</span>d:	<span class="number">41</span> <span class="number">5</span>c                	pop    %r12</span><br><span class="line"><span class="number">4011f</span>f:	<span class="number">41</span> <span class="number">5</span>d                	pop    %r13</span><br><span class="line"><span class="number">401201</span>:	<span class="number">41</span> <span class="number">5</span>e                	pop    %r14</span><br><span class="line"><span class="number">401203</span>:	c3                   	retq</span><br></pre></td></tr></table></figure>
<p>把立即数0x5赋值给ebp，ebp将控制循环次数。rbx的值是之前的rsp+0x20，那么rbx+0x8这个地址中存放的值就是下一个节点的地址，赋给了rax。将rax代表的节点的数据低四字节取出放入eax，再与rbx代表的节点的数据的值的低4位进行比较，如果前一个节点的数据的低4字节大于等于后一个节点的，则不引爆炸弹。<br>数据由大到小的排列依次是3 4 5 6 1 2。<br>由于有一步x = 7 - x，所以倒推回来的答案应该是：<code>4 3 2 1 6 5</code></p>
<h1 id="secret-phase"><a href="#secret-phase" class="headerlink" title="secret_phase"></a>secret_phase</h1><p>至此，六个关卡我们均顺利通过，但是在phase_6之后还有<code>func7</code>和<code>secret_phase</code>,然而在func7中并没有调用secret_phase函数，通过全局查找我们在<code>phase_defused</code>中找到了调用该函数的入口，接下来我们分析一下如何进入<code>secret_phase</code>。<br>以下为<code>phase_defused</code>的汇编代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000004015</span>c4 &lt;phase_defused&gt;:</span><br><span class="line">  <span class="number">4015</span>c4:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">78</span>          	sub    $<span class="number">0x78</span>,%rsp</span><br><span class="line">  <span class="number">4015</span>c8:	<span class="number">64</span> <span class="number">48</span> <span class="number">8b</span> <span class="number">04</span> <span class="number">25</span> <span class="number">28</span> <span class="number">00</span> 	mov    %fs:<span class="number">0x28</span>,%rax</span><br><span class="line">  <span class="number">4015</span>cf:	<span class="number">00</span> <span class="number">00</span> </span><br><span class="line">  <span class="number">4015</span>d1:	<span class="number">48</span> <span class="number">89</span> <span class="number">44</span> <span class="number">24</span> <span class="number">68</span>       	mov    %rax,<span class="number">0x68</span>(%rsp)</span><br><span class="line">  <span class="number">4015</span>d6:	<span class="number">31</span> c0                	<span class="keyword">xor</span>    %eax,%eax</span><br><span class="line">  <span class="number">4015</span>d8:	<span class="number">83</span> <span class="number">3</span>d <span class="number">81</span> <span class="number">21</span> <span class="number">20</span> <span class="number">00</span> <span class="number">06</span> 	cmpl   $<span class="number">0x6</span>,<span class="number">0x202181</span>(%rip)        # <span class="number">603760</span> &lt;num_input_strings&gt;</span><br><span class="line">  <span class="number">4015</span>df:	<span class="number">75</span> <span class="number">5</span>e                	jne    <span class="number">40163f</span> &lt;phase_defused+<span class="number">0x7b</span>&gt;</span><br><span class="line">  <span class="number">4015e1</span>:	<span class="number">4</span>c <span class="number">8</span>d <span class="number">44</span> <span class="number">24</span> <span class="number">10</span>       	lea    <span class="number">0x10</span>(%rsp),%r8</span><br><span class="line">  <span class="number">4015e6</span>:	<span class="number">48</span> <span class="number">8</span>d <span class="number">4</span>c <span class="number">24</span> <span class="number">0</span>c       	lea    <span class="number">0xc</span>(%rsp),%rcx</span><br><span class="line">  <span class="number">4015</span>eb:	<span class="number">48</span> <span class="number">8</span>d <span class="number">54</span> <span class="number">24</span> <span class="number">08</span>       	lea    <span class="number">0x8</span>(%rsp),%rdx</span><br><span class="line">  <span class="number">4015f</span>0:	be <span class="number">19</span> <span class="number">26</span> <span class="number">40</span> <span class="number">00</span>       	mov    $<span class="number">0x402619</span>,%esi</span><br><span class="line">  <span class="number">4015f</span>5:	bf <span class="number">70</span> <span class="number">38</span> <span class="number">60</span> <span class="number">00</span>       	mov    $<span class="number">0x603870</span>,%edi</span><br><span class="line">  <span class="number">4015f</span>a:	e8 f1 f5 ff ff       	callq  <span class="number">400b</span>f0 &lt;__isoc99_sscanf@plt&gt;</span><br><span class="line">  <span class="number">4015f</span>f:	<span class="number">83</span> f8 <span class="number">03</span>             	cmp    $<span class="number">0x3</span>,%eax</span><br><span class="line">  <span class="number">401602</span>:	<span class="number">75</span> <span class="number">31</span>                	jne    <span class="number">401635</span> &lt;phase_defused+<span class="number">0x71</span>&gt;</span><br><span class="line">  <span class="number">401604</span>:	be <span class="number">22</span> <span class="number">26</span> <span class="number">40</span> <span class="number">00</span>       	mov    $<span class="number">0x402622</span>,%esi</span><br><span class="line">  <span class="number">401609</span>:	<span class="number">48</span> <span class="number">8</span>d <span class="number">7</span>c <span class="number">24</span> <span class="number">10</span>       	lea    <span class="number">0x10</span>(%rsp),%rdi</span><br><span class="line">  <span class="number">40160</span>e:	e8 <span class="number">25</span> fd ff ff       	callq  <span class="number">401338</span> &lt;strings_not_equal&gt;</span><br><span class="line">  <span class="number">401613</span>:	<span class="number">85</span> c0                	test   %eax,%eax</span><br><span class="line">  <span class="number">401615</span>:	<span class="number">75</span> <span class="number">1</span>e                	jne    <span class="number">401635</span> &lt;phase_defused+<span class="number">0x71</span>&gt;</span><br><span class="line">  <span class="number">401617</span>:	bf f8 <span class="number">24</span> <span class="number">40</span> <span class="number">00</span>       	mov    $<span class="number">0x4024f8</span>,%edi</span><br><span class="line">  <span class="number">40161</span>c:	e8 ef f4 ff ff       	callq  <span class="number">400b</span>10 &lt;<span class="built_in">puts</span>@plt&gt;</span><br><span class="line">  <span class="number">401621</span>:	bf <span class="number">20</span> <span class="number">25</span> <span class="number">40</span> <span class="number">00</span>       	mov    $<span class="number">0x402520</span>,%edi</span><br><span class="line">  <span class="number">401626</span>:	e8 e5 f4 ff ff       	callq  <span class="number">400b</span>10 &lt;<span class="built_in">puts</span>@plt&gt;</span><br><span class="line">  <span class="number">40162b</span>:	b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x0</span>,%eax</span><br><span class="line">  <span class="number">401630</span>:	e8 <span class="number">0</span>d fc ff ff       	callq  <span class="number">401242</span> &lt;secret_phase&gt;</span><br><span class="line">  <span class="number">401635</span>:	bf <span class="number">58</span> <span class="number">25</span> <span class="number">40</span> <span class="number">00</span>       	mov    $<span class="number">0x402558</span>,%edi</span><br><span class="line">  <span class="number">40163</span>a:	e8 d1 f4 ff ff       	callq  <span class="number">400b</span>10 &lt;<span class="built_in">puts</span>@plt&gt;</span><br><span class="line">  <span class="number">40163f</span>:	<span class="number">48</span> <span class="number">8b</span> <span class="number">44</span> <span class="number">24</span> <span class="number">68</span>       	mov    <span class="number">0x68</span>(%rsp),%rax</span><br><span class="line">  <span class="number">401644</span>:	<span class="number">64</span> <span class="number">48</span> <span class="number">33</span> <span class="number">04</span> <span class="number">25</span> <span class="number">28</span> <span class="number">00</span> 	<span class="keyword">xor</span>    %fs:<span class="number">0x28</span>,%rax</span><br><span class="line">  <span class="number">40164b</span>:	<span class="number">00</span> <span class="number">00</span> </span><br><span class="line">  <span class="number">40164</span>d:	<span class="number">74</span> <span class="number">05</span>                	je     <span class="number">401654</span> &lt;phase_defused+<span class="number">0x90</span>&gt;</span><br><span class="line">  <span class="number">40164f</span>:	e8 dc f4 ff ff       	callq  <span class="number">400b</span>30 &lt;__stack_chk_fail@plt&gt;</span><br><span class="line">  <span class="number">401654</span>:	<span class="number">48</span> <span class="number">83</span> c4 <span class="number">78</span>          	add    $<span class="number">0x78</span>,%rsp</span><br><span class="line">  <span class="number">401658</span>:	c3                   	retq   </span><br><span class="line">  <span class="number">401659</span>:	<span class="number">90</span>                   	nop</span><br><span class="line">  <span class="number">40165</span>a:	<span class="number">90</span>                   	nop</span><br><span class="line">  <span class="number">40165b</span>:	<span class="number">90</span>                   	nop</span><br><span class="line">  <span class="number">40165</span>c:	<span class="number">90</span>                   	nop</span><br><span class="line">  <span class="number">40165</span>d:	<span class="number">90</span>                   	nop</span><br><span class="line">  <span class="number">40165</span>e:	<span class="number">90</span>                   	nop</span><br><span class="line">  <span class="number">40165f</span>:	<span class="number">90</span>                   	nop</span><br></pre></td></tr></table></figure>
<p>在第7行将输入字符串数目与6进行比较，如果不等于6则直接跳转至最后。也就是说通过前面六关以后并且炸弹没有爆炸就才会执行此后的代码。<br>在第12行和第13行分别将两个地址传给esi和edi,<code>x/s 0x402619</code>查看0x402619处的字符串</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x402619:       &quot;%d %d %s&quot;</span><br></pre></td></tr></table></figure>
<p>输入格式为两个整数和一个字符串。<br>在12行之后又有一行给edi赋上了一个地址值，我们之前所有阶段中edi的值都是来自于我们read_line的地址，我们推测传入地址对应此前某一关卡我们所输入的内容，<mark class="label default">x/s 0x603870</mark>，显示如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x603870</span> &lt;input_strings+<span class="number">240</span>&gt;:   <span class="string">&quot;7 0&quot;</span></span><br></pre></td></tr></table></figure>
<p>符号表input_string验证了我们的想法，7 0即为第四关我们输入的内容。<br>第17-19行是对strings_not_equal的调用，我们已经知道它的两个参数分别是esi与edi，esi被赋上了一个地址值，edi被赋上了esp+0x10，我们可以推测出edi的地址就是指向我们读入的第三个字符串的，根据之前的经验，rsi中存储的应该是比较的字符串，我们在运行时输入<mark class="label default">x/s 0x402622</mark>查看内存的内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x402622</span>:       <span class="string">&quot;DrEvil&quot;</span></span><br></pre></td></tr></table></figure>
<p>顺利进入secret_phase关卡，secret_phase对应汇编代码如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">0000000000401242 &lt;secret_phase&gt;:</span><br><span class="line">  401242:	53                   	push   %rbx</span><br><span class="line">  401243:	e8 56 02 00 00       	callq  40149e &lt;read_line&gt;</span><br><span class="line">  401248:	ba 0a 00 00 00       	mov    $0xa,%edx</span><br><span class="line">  40124d:	be 00 00 00 00       	mov    $0x0,%esi</span><br><span class="line">  401252:	48 89 c7             	mov    %rax,%rdi</span><br><span class="line">  401255:	e8 76 f9 ff ff       	callq  400bd0 &lt;strtol@plt&gt;</span><br><span class="line">  40125a:	48 89 c3             	mov    %rax,%rbx</span><br><span class="line">  40125d:	8d 40 ff             	lea    -0x1(%rax),%eax</span><br><span class="line">  401260:	3d e8 03 00 00       	cmp    $0x3e8,%eax</span><br><span class="line">  401265:	76 05                	jbe    40126c &lt;secret_phase+0x2a&gt;</span><br><span class="line">  401267:	e8 ce 01 00 00       	callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  40126c:	89 de                	mov    %ebx,%esi</span><br><span class="line">  40126e:	bf f0 30 60 00       	mov    $0x6030f0,%edi</span><br><span class="line">  401273:	e8 8c ff ff ff       	callq  401204 &lt;fun7&gt;</span><br><span class="line">  401278:	83 f8 02             	cmp    $0x2,%eax</span><br><span class="line">  40127b:	74 05                	je     401282 &lt;secret_phase+0x40&gt;</span><br><span class="line">  40127d:	e8 b8 01 00 00       	callq  40143a &lt;explode_bomb&gt;</span><br><span class="line">  401282:	bf 38 24 40 00       	mov    $0x402438,%edi</span><br><span class="line">  401287:	e8 84 f8 ff ff       	callq  400b10 &lt;puts@plt&gt;</span><br><span class="line">  40128c:	e8 33 03 00 00       	callq  4015c4 &lt;phase_defused&gt;</span><br><span class="line">  401291:	5b                   	pop    %rbx</span><br><span class="line">  401292:	c3                   	retq</span><br></pre></td></tr></table></figure>
<p>第3行调用了read_line函数，读入一行，然后将返回结果赋值给rdi,之后调用了strtol函数，这个标准库函数的作用是把一个字符串转换成对应的长整型数值。第8行将rax赋值给rbx，第9行将rax减1赋给eax，第10行与0x3e8进行比较，如果这个值小于等于0x3e8就跳过引爆代码。由此可知，我们应该输入一行数据，数值小于等于1001。<br>接下来将ebx赋给了esi，也就是我们一开始输入的数据的值。第14行将一个地址值赋给了edi，15行调用了fun7函数。在调用返回后令rax与2作比较，如果相等则跳过引爆代码。<br>查看func7的代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0000000000401204</span> &lt;fun7&gt;:</span><br><span class="line">  <span class="number">401204</span>:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">08</span>          	sub    $<span class="number">0x8</span>,%rsp</span><br><span class="line">  <span class="number">401208</span>:	<span class="number">48</span> <span class="number">85</span> ff             	test   %rdi,%rdi</span><br><span class="line">  <span class="number">40120b</span>:	<span class="number">74</span> <span class="number">2b</span>                	je     <span class="number">401238</span> &lt;fun7+<span class="number">0x34</span>&gt;</span><br><span class="line">  <span class="number">40120</span>d:	<span class="number">8b</span> <span class="number">17</span>                	mov    (%rdi),%edx</span><br><span class="line">  <span class="number">40120f</span>:	<span class="number">39</span> f2                	cmp    %esi,%edx</span><br><span class="line">  <span class="number">401211</span>:	<span class="number">7</span>e <span class="number">0</span>d                	jle    <span class="number">401220</span> &lt;fun7+<span class="number">0x1c</span>&gt;</span><br><span class="line">  <span class="number">401213</span>:	<span class="number">48</span> <span class="number">8b</span> <span class="number">7f</span> <span class="number">08</span>          	mov    <span class="number">0x8</span>(%rdi),%rdi</span><br><span class="line">  <span class="number">401217</span>:	e8 e8 ff ff ff       	callq  <span class="number">401204</span> &lt;fun7&gt;</span><br><span class="line">  <span class="number">40121</span>c:	<span class="number">01</span> c0                	add    %eax,%eax</span><br><span class="line">  <span class="number">40121</span>e:	eb <span class="number">1</span>d                	jmp    <span class="number">40123</span>d &lt;fun7+<span class="number">0x39</span>&gt;</span><br><span class="line">  <span class="number">401220</span>:	b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x0</span>,%eax</span><br><span class="line">  <span class="number">401225</span>:	<span class="number">39</span> f2                	cmp    %esi,%edx</span><br><span class="line">  <span class="number">401227</span>:	<span class="number">74</span> <span class="number">14</span>                	je     <span class="number">40123</span>d &lt;fun7+<span class="number">0x39</span>&gt;</span><br><span class="line">  <span class="number">401229</span>:	<span class="number">48</span> <span class="number">8b</span> <span class="number">7f</span> <span class="number">10</span>          	mov    <span class="number">0x10</span>(%rdi),%rdi</span><br><span class="line">  <span class="number">40122</span>d:	e8 d2 ff ff ff       	callq  <span class="number">401204</span> &lt;fun7&gt;</span><br><span class="line">  <span class="number">401232</span>:	<span class="number">8</span>d <span class="number">44</span> <span class="number">00</span> <span class="number">01</span>          	lea    <span class="number">0x1</span>(%rax,%rax,<span class="number">1</span>),%eax</span><br><span class="line">  <span class="number">401236</span>:	eb <span class="number">05</span>                	jmp    <span class="number">40123</span>d &lt;fun7+<span class="number">0x39</span>&gt;</span><br><span class="line">  <span class="number">401238</span>:	b8 ff ff ff ff       	mov    $<span class="number">0xffffffff</span>,%eax</span><br><span class="line">  <span class="number">40123</span>d:	<span class="number">48</span> <span class="number">83</span> c4 <span class="number">08</span>          	add    $<span class="number">0x8</span>,%rsp</span><br><span class="line">  <span class="number">401241</span>:	c3                   	retq  </span><br></pre></td></tr></table></figure>
<p>3、4两行先对传入参数rdi进行判断，如果等于0直接跳到第19行，返回-1，我们想让函数返回2，显然不可以让rdi等于0</p>
<p>第5行将rdi的值读入到了edx中，第6行则将这个数与我们读入的数进行比较，如果这个数小于等于我们读入的数就跳至第12行，第12行将eax置0，再次比较esi和edx，如果相等则跳至第20行返回。</p>
<p>如果不等（也就是edx小于我们读入的数），则继续向下执行第15行，这行代码有些与之前的链表跳至下一个节点类似，到这里，我们就需要查看一下rdi这个地址里存放的是怎样一种数据结构：</p>
<mark class="label default">x/120a 0x6030f0</mark>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x6030f0</span> &lt;n1&gt;:  <span class="number">0x24</span>    <span class="number">0x603110</span> &lt;n21&gt;</span><br><span class="line"><span class="number">0x603100</span> &lt;n1+<span class="number">16</span>&gt;:   <span class="number">0x603130</span> &lt;n22&gt;  <span class="number">0x0</span></span><br><span class="line"><span class="number">0x603110</span> &lt;n21&gt;: <span class="number">0x8</span> <span class="number">0x603190</span> &lt;n31&gt;</span><br><span class="line"><span class="number">0x603120</span> &lt;n21+<span class="number">16</span>&gt;:  <span class="number">0x603150</span> &lt;n32&gt;  <span class="number">0x0</span></span><br><span class="line"><span class="number">0x603130</span> &lt;n22&gt;: <span class="number">0x32</span>    <span class="number">0x603170</span> &lt;n33&gt;</span><br><span class="line"><span class="number">0x603140</span> &lt;n22+<span class="number">16</span>&gt;:  <span class="number">0x6031b0</span> &lt;n34&gt;  <span class="number">0x0</span></span><br><span class="line"><span class="number">0x603150</span> &lt;n32&gt;: <span class="number">0x16</span>    <span class="number">0x603270</span> &lt;n43&gt;</span><br><span class="line"><span class="number">0x603160</span> &lt;n32+<span class="number">16</span>&gt;:  <span class="number">0x603230</span> &lt;n44&gt;  <span class="number">0x0</span></span><br><span class="line"><span class="number">0x603170</span> &lt;n33&gt;: <span class="number">0x2d</span>    <span class="number">0x6031d0</span> &lt;n45&gt;</span><br><span class="line"><span class="number">0x603180</span> &lt;n33+<span class="number">16</span>&gt;:  <span class="number">0x603290</span> &lt;n46&gt;  <span class="number">0x0</span></span><br><span class="line"><span class="number">0x603190</span> &lt;n31&gt;: <span class="number">0x6</span> <span class="number">0x6031f0</span> &lt;n41&gt;</span><br><span class="line"><span class="number">0x6031a0</span> &lt;n31+<span class="number">16</span>&gt;:  <span class="number">0x603250</span> &lt;n42&gt;  <span class="number">0x0</span></span><br><span class="line"><span class="number">0x6031b0</span> &lt;n34&gt;: <span class="number">0x6b</span>    <span class="number">0x603210</span> &lt;n47&gt;</span><br><span class="line"><span class="number">0x6031c0</span> &lt;n34+<span class="number">16</span>&gt;:  <span class="number">0x6032b0</span> &lt;n48&gt;  <span class="number">0x0</span></span><br><span class="line"><span class="number">0x6031d0</span> &lt;n45&gt;: <span class="number">0x28</span>    <span class="number">0x0</span></span><br><span class="line"><span class="number">0x6031e0</span> &lt;n45+<span class="number">16</span>&gt;:  <span class="number">0x0</span> <span class="number">0x0</span></span><br><span class="line"><span class="number">0x6031f0</span> &lt;n41&gt;: <span class="number">0x1</span> <span class="number">0x0</span></span><br><span class="line"><span class="number">0x603200</span> &lt;n41+<span class="number">16</span>&gt;:  <span class="number">0x0</span> <span class="number">0x0</span></span><br><span class="line"><span class="number">0x603210</span> &lt;n47&gt;: <span class="number">0x63</span>    <span class="number">0x0</span></span><br><span class="line"><span class="number">0x603220</span> &lt;n47+<span class="number">16</span>&gt;:  <span class="number">0x0</span> <span class="number">0x0</span></span><br><span class="line"><span class="number">0x603230</span> &lt;n44&gt;: <span class="number">0x23</span>    <span class="number">0x0</span></span><br><span class="line"><span class="number">0x603240</span> &lt;n44+<span class="number">16</span>&gt;:  <span class="number">0x0</span> <span class="number">0x0</span></span><br><span class="line"><span class="number">0x603250</span> &lt;n42&gt;: <span class="number">0x7</span> <span class="number">0x0</span></span><br><span class="line"><span class="number">0x603260</span> &lt;n42+<span class="number">16</span>&gt;:  <span class="number">0x0</span> <span class="number">0x0</span></span><br><span class="line"><span class="number">0x603270</span> &lt;n43&gt;: <span class="number">0x14</span>    <span class="number">0x0</span></span><br><span class="line"><span class="number">0x603280</span> &lt;n43+<span class="number">16</span>&gt;:  <span class="number">0x0</span> <span class="number">0x0</span></span><br><span class="line"><span class="number">0x603290</span> &lt;n46&gt;: <span class="number">0x2f</span>    <span class="number">0x0</span></span><br><span class="line"><span class="number">0x6032a0</span> &lt;n46+<span class="number">16</span>&gt;:  <span class="number">0x0</span> <span class="number">0x0</span></span><br><span class="line"><span class="number">0x6032b0</span> &lt;n48&gt;: <span class="number">0x3e9</span>   <span class="number">0x0</span></span><br><span class="line"><span class="number">0x6032c0</span> &lt;n48+<span class="number">16</span>&gt;:  <span class="number">0x0</span> <span class="number">0x0</span></span><br></pre></td></tr></table></figure>
<p>仔细观察可以发现这是一个二叉树的结构，每个节点第1个8字节存放数据，第2个8字节存放左子树地址，第3个8字节存放右子树位置。并且命令也有规律，nab，a代表层数，b代表从左至右第b个节点。<br>edi指向一个树的节点，令edi节点的值与我们读入的值进行比较</p>
<ul>
<li>如果两者相等：返回0</li>
<li>如果前者大于后者：rdi移至左子树，返回2*rax</li>
<li>如果后者大于前者：rdi移至右子树，返回2*rax + 1<br>根据递归调用，如果我们需要返回2，应该在最后一次调用返回0，倒数第二次调用返回2 * rax + 1，第一次调用返回2 * rax。这个数应该在第三层，比父节点大且比根结节小。观察上图，唯一的答案是：0x16(22)</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          

<div class="post-copyright">
<ul>
  <li class="post-copyright-author">
      <strong>本文作者： </strong>trinkle
  </li>
  <li class="post-copyright-link">
      <strong>本文链接：</strong>
      <a href="http://example.com/systems/bomblab/" title="bomblab">http://example.com/systems/bomblab/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

          <div class="post-tags">
              <a href="/tags/csapp/" rel="tag"><i class="fa fa-tag"></i> csapp</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
            </div>
            <div class="post-nav-item">
                <a href="/systems/datalab/" rel="next" title="datalab">
                  datalab <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>







<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">trinkle</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/mist/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.1.0/lib/anime.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  
<script src="/js/local-search.js"></script>






  




  


</body>
</html>
